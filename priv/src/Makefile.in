SHELL = /bin/sh
VPATH = @srcdir@

LDFLAGS_COMMON=
CFLAGS_COMMON=-Wall -O2 -DXP_UNIX -Iinclude/js @ERL_FLAGS@ -I.

top_srcdir = @top_srcdir@
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(exec_prefix)/bin
infodir = $(prefix)/info
libdir = $(prefix)/lib/gnudl
mandir = $(prefix)/man/man1
CFLAGS = @CFLAGS@ $(CFLAGS_COMMON)

ifeq ($(shell uname),Linux)
	ARCH = linux
	LDFLAGS = $(LDFLAGS_COMMON) -shared
else
	ARCH = macosx
	LDFLAGS = $(LDFLAGS_COMMON) -dynamic -bundle -undefined suppress -flat_namespace
endif


CC = @CC@
CPPFLAGS = @CPPFLAGS@ $(CFLAGS_COMMON)
LIBS = @LIBS@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

OUTPUTFILES := $(patsubst %_drv.c, %_drv.so, $(wildcard *_drv.c))

DEFS = -DHAVE_CONFIG_H

ERLDIR = @ERLDIR@


all: ../libjs.a $(OUTPUTFILES)

debug:
	$(MAKE) DEBUG=-DDEBUG

.SUFFIXES: .o .c .h

%_drv.so: %_drv.o driver_comm.o spidermonkey.o
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) $(LDFLAGS) -o ../$@ $^ @LIBEI@ ../libjs.a ../libnspr4.a
.c.o: build/js/include
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -c $<

clean:
	@rm -rf *.o *.a $(OUTPUTFILES)
	@rm -rf config.status config.log autom4te.cache
	@rm -f *flymake*
	@rm -f ../*.so ../*.a
	@rm -rf include

dist:
	@rm -rf *.o *.a $(OUTPUTFILES)
	@rm -rf config.status config.log autom4te.cache
	@rm -f *flymake*
	@rm -rf include
	@rm -rf build

jsclean: clean
	@rm -rf build

../libnspr4.a: build/nspr_release/dist/lib/libnspr4.a
	@cp build/nspr_release/dist/lib/libnspr4.a ..

../libjs.a: ../libnspr4.a js/src/libjs.a
	@cp build/js/src/libjs.a ..

build/nspr_release/dist/lib/libnspr4.a: build/mozilla build/nspr_release
	@cd build/nspr_release;../mozilla/nsprpub/configure --disable-debug --enable-optimize;make

build/mozilla:
	@mkdir -p $(@)
	@cvs -q -d :pserver:anonymous@cvs-mirror.mozilla.org:/cvsroot co -r NSPR_4_8_RTM mozilla/nsprpub
	@mv mozilla build

build/nspr_release:
	@mkdir -p $(@)

js/src/libjs.a: build/js
	@cd build/js/src;make BUILD_OPT=1 JS_DIST=../../nspr_release/dist JS_THREADSAFE=1 XCFLAGS="-DHAVE_VA_COPY -DVA_COPY=va_copy" -f Makefile.ref
	@cp build/js/src/*_OPT.OBJ/libjs.a build/js/src
	@mkdir -p include/js;
	@cp build/js/src/*.h include/js
	@cp build/js/src/*.tbl include/js
	@cp build/js/src/*_OPT.OBJ/*.h include/js

build/js:
	@tar -C build -xzf js-1.8.0-rc1.tar.gz
